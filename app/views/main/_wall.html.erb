<div id="wall">
<!--  <div id="records">-->

<!--  </div>-->

<!--  <div id="new_record">-->
<!--    <form name="wallForm" id="wallForm" onsubmit="send_wall_form();return false">-->
      <%#= hidden_field_tag :authenticity_token, form_authenticity_token %>
<!--      <textarea name="body">-->

<!--      </textarea>-->
<!--      <button type="submit">-->
<!--        Отправить-->
<!--      </button>-->
<!--    </form>-->
<!--  </div>-->


  <section class="chatbox">
    <section class="chat-window" id="chat-window">


      <% Wall.all.each do |message| %>
        <% if message.user_id == @current_user.id %>
          <article class="msg-container msg-self" id="msg-0">
            <div class="msg-box msg-<%= message.tag %>">
              <div class="flr">
                <div class="messages">
                  <p class="msg" id="msg-1">
                    <%= message.body %>
                  </p>
                </div>

                <% time = Time.current - message.created_at %>
                <% case time %>
                <% when 0..3600 %>
                  <% text_time = "#{(time/60).round } minutes ago" %>
                <% when 3660..(3600*24) %>
                  <% text_time = "#{(time/3600).round} hours ago" %>
                <% when (3600*24)..(3600*48) %>
                  <% text_time =  "yesterday"  %>
                <% else  %>
                  <% text_time =  message.created_at.strftime("%d.%m.%Y %H:%M") %>
                <% end %>
                <span class="timestamp"><span class="username">Вы</span>&bull;
              <span class="posttime"> <%= text_time %></span> &bull;

                  <% if message.tag == 'important' %>
                <span title="Важная информация">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="25" fill="currentColor" class="bi bi-exclamation-octagon" viewBox="0 0 16 7">
          <path d="M4.54.146A.5.5 0 0 1 4.893 0h6.214a.5.5 0 0 1 .353.146l4.394 4.394a.5.5 0 0 1 .146.353v6.214a.5.5 0 0 1-.146.353l-4.394 4.394a.5.5 0 0 1-.353.146H4.893a.5.5 0 0 1-.353-.146L.146 11.46A.5.5 0 0 1 0 11.107V4.893a.5.5 0 0 1 .146-.353L4.54.146zM5.1 1 1 5.1v5.8L5.1 15h5.8l4.1-4.1V5.1L10.9 1H5.1z"/>
          <path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 4.995z"/>
        </svg>
                </span>
          <% elsif message.tag == 'random' %>
                <span title="Это смешно">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="25" fill="currentColor" class="bi bi-emoji-laughing" viewBox="0 0 16 7">
          <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
          <path d="M12.331 9.5a1 1 0 0 1 0 1A4.998 4.998 0 0 1 8 13a4.998 4.998 0 0 1-4.33-2.5A1 1 0 0 1 4.535 9h6.93a1 1 0 0 1 .866.5zM7 6.5c0 .828-.448 0-1 0s-1 .828-1 0S5.448 5 6 5s1 .672 1 1.5zm4 0c0 .828-.448 0-1 0s-1 .828-1 0S9.448 5 10 5s1 .672 1 1.5z"/>
        </svg>
                </span>
        <% elsif message.tag == 'interesting' %>
                <span title="Это может быть интересно">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="30" fill="currentColor" class="bi bi-lightbulb" viewBox="0 0 16 3">
          <path d="M2 6a6 6 0 1 1 10.174 4.31c-.203.196-.359.4-.453.619l-.762 1.769A.5.5 0 0 1 10.5 13a.5.5 0 0 1 0 1 .5.5 0 0 1 0 1l-.224.447a1 1 0 0 1-.894.553H6.618a1 1 0 0 1-.894-.553L5.5 15a.5.5 0 0 1 0-1 .5.5 0 0 1 0-1 .5.5 0 0 1-.46-.302l-.761-1.77a1.964 1.964 0 0 0-.453-.618A5.984 5.984 0 0 1 2 6zm6-5a5 5 0 0 0-3.479 8.592c.263.254.514.564.676.941L5.83 12h4.342l.632-1.467c.162-.377.413-.687.676-.941A5 5 0 0 0 8 1z"/>
        </svg>
                </span>
        <% elsif message.tag == 'advertisement' %>
                <span title="Объявление">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pin-angle-fill" viewBox="0 0 16 10">
          <path d="M9.828.722a.5.5 0 0 1 .354.146l4.95 4.95a.5.5 0 0 1 0 .707c-.48.48-1.072.588-1.503.588-.177 0-.335-.018-.46-.039l-3.134 3.134a5.927 5.927 0 0 1 .16 1.013c.046.702-.032 1.687-.72 2.375a.5.5 0 0 1-.707 0l-2.829-2.828-3.182 3.182c-.195.195-1.219.902-1.414.707-.195-.195.512-1.22.707-1.414l3.182-3.182-2.828-2.829a.5.5 0 0 1 0-.707c.688-.688 1.673-.767 2.375-.72a5.922 5.922 0 0 1 1.013.16l3.134-3.133a2.772 2.772 0 0 1-.04-.461c0-.43.108-1.022.589-1.503a.5.5 0 0 1 .353-.146z"/>
        </svg>
                </span>
            <% end %>
                </span>
              </div>
              <% if message.user.avatar.attached? %>
                <img class="user-img" id="user-0" src="<%= message.user.avatar.url %>" />
              <% else %>
                <img class="user-img" id="user-0" src="../assets/avatar<%= rand(5) + 1 %>.jpeg" />
              <% end %>

            </div>
          </article>
          <% else %>
      <article class="msg-container msg-remote" id="msg-0">
        <div class="msg-box msg-<%= message.tag %>">
          <% if message.user.avatar.attached? %>
            <img class="user-img" id="user-0" src="<%= message.user.avatar.url %>" />
          <% else %>
            <img class="user-img" id="user-0" src="../assets/avatar<%= rand(5) + 1 %>.jpeg" />
          <% end %>
          <div class="flr">
            <div class="messages">
              <p class="msg" id="msg-0">
                <%= message.body %>
              </p>
            </div>


            <% time = Time.current - message.created_at %>
            <% case time %>
            <% when 0..3600 %>
              <% text_time = "#{(time/60).round } minutes ago" %>
            <% when 3660..(3600*24) %>
              <% text_time = "#{(time/3600).round} hours ago" %>
            <% when (3600*24)..(3600*48) %>
              <% text_time =  "yesterday"  %>
            <% else  %>
              <% text_time =  message.created_at.strftime("%d.%m.%Y %H:%M") %>
            <% end %>

            <span class="timestamp"><span class="username"> <%= message.user.full_name %> </span>&bull;
              <span class="posttime"><%= text_time %> </span>&bull;

              <% if message.tag == 'important' %>
                <span title="Важная информация">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="25" fill="currentColor" class="bi bi-exclamation-octagon for_margin" viewBox="0 0 16 7">
          <path d="M4.54.146A.5.5 0 0 1 4.893 0h6.214a.5.5 0 0 1 .353.146l4.394 4.394a.5.5 0 0 1 .146.353v6.214a.5.5 0 0 1-.146.353l-4.394 4.394a.5.5 0 0 1-.353.146H4.893a.5.5 0 0 1-.353-.146L.146 11.46A.5.5 0 0 1 0 11.107V4.893a.5.5 0 0 1 .146-.353L4.54.146zM5.1 1 1 5.1v5.8L5.1 15h5.8l4.1-4.1V5.1L10.9 1H5.1z"/>
          <path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 4.995z"/>
        </svg>
                </span>
          <% elsif message.tag == 'random' %>
                <span title="Это смешно">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="25" fill="currentColor" class="bi bi-emoji-laughing for_margin" viewBox="0 0 16 7">
          <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
          <path d="M12.331 9.5a1 1 0 0 1 0 1A4.998 4.998 0 0 1 8 13a4.998 4.998 0 0 1-4.33-2.5A1 1 0 0 1 4.535 9h6.93a1 1 0 0 1 .866.5zM7 6.5c0 .828-.448 0-1 0s-1 .828-1 0S5.448 5 6 5s1 .672 1 1.5zm4 0c0 .828-.448 0-1 0s-1 .828-1 0S9.448 5 10 5s1 .672 1 1.5z"/>
        </svg>
                </span>
        <% elsif message.tag == 'interesting' %>
                <span title="Это может быть интересно">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="30" fill="currentColor" class="bi bi-lightbulb for_margin" viewBox="0 0 16 3">
          <path d="M2 6a6 6 0 1 1 10.174 4.31c-.203.196-.359.4-.453.619l-.762 1.769A.5.5 0 0 1 10.5 13a.5.5 0 0 1 0 1 .5.5 0 0 1 0 1l-.224.447a1 1 0 0 1-.894.553H6.618a1 1 0 0 1-.894-.553L5.5 15a.5.5 0 0 1 0-1 .5.5 0 0 1 0-1 .5.5 0 0 1-.46-.302l-.761-1.77a1.964 1.964 0 0 0-.453-.618A5.984 5.984 0 0 1 2 6zm6-5a5 5 0 0 0-3.479 8.592c.263.254.514.564.676.941L5.83 12h4.342l.632-1.467c.162-.377.413-.687.676-.941A5 5 0 0 0 8 1z"/>
        </svg>
                </span>
        <% elsif message.tag == 'advertisement' %>
                <span title="Объявление">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pin-angle-fill for_margin" viewBox="0 0 16 10">
          <path d="M9.828.722a.5.5 0 0 1 .354.146l4.95 4.95a.5.5 0 0 1 0 .707c-.48.48-1.072.588-1.503.588-.177 0-.335-.018-.46-.039l-3.134 3.134a5.927 5.927 0 0 1 .16 1.013c.046.702-.032 1.687-.72 2.375a.5.5 0 0 1-.707 0l-2.829-2.828-3.182 3.182c-.195.195-1.219.902-1.414.707-.195-.195.512-1.22.707-1.414l3.182-3.182-2.828-2.829a.5.5 0 0 1 0-.707c.688-.688 1.673-.767 2.375-.72a5.922 5.922 0 0 1 1.013.16l3.134-3.133a2.772 2.772 0 0 1-.04-.461c0-.43.108-1.022.589-1.503a.5.5 0 0 1 .353-.146z"/>
        </svg>
                </span>
            <% end %>

            </span>
          </div>
        </div>



      </article>
          <% end %>
<% end %>

    </section>

    <div id="emoji2" class="hidden"></div>

    <div id="tags" class="hidden">
      <% Wall::TAGS.each do |tag| %>
      <input id="<%= tag[0] %>" form="i_am_form" type="radio" name="tag" value="<%= tag[0] %>" <% if tag[0] == :advertisement %> checked <% end %>>
        <label for="<%= tag[0] %>"><%= tag[1] %></label><br>
        <% end %>
    </div>

    <form class="chat-input" onsubmit="send_wall_form();return false" id="i_am_form" name="wallForm">
      <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
      <input type="text" autocomplete="on" placeholder="Type a message" id="message_input" name="body" required maxlength="200"/>

        <svg onclick="show_emojis('tags')" xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" class="bi bi-tag send_icon" viewBox="0 0 16 16">
          <path d="M6 4.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm-1 0a.5.5 0 1 0-1 0 .5.5 0 0 0 1 0z"/>
          <path d="M2 1h4.586a1 1 0 0 1 .707.293l7 7a1 1 0 0 1 0 1.414l-4.586 4.586a1 1 0 0 1-1.414 0l-7-7A1 1 0 0 1 1 6.586V2a1 1 0 0 1 1-1zm0 5.586 7 7L13.586 9l-7-7H2v4.586z"/>
        </svg>
        <svg onclick="show_emojis('emoji2')" xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" class="bi bi-emoji-smile send_icon" viewBox="0 0 16 16">
          <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
          <path d="M4.285 9.567a.5.5 0 0 1 .683.183A3.498 3.498 0 0 0 8 11.5a3.498 3.498 0 0 0 3.032-1.75.5.5 0 1 1 .866.5A4.498 4.498 0 0 1 8 12.5a4.498 4.498 0 0 1-3.898-2.25.5.5 0 0 1 .183-.683zM7 6.5C7 7.328 6.552 8 6 8s-1-.672-1-1.5S5.448 5 6 5s1 .672 1 1.5zm4 0c0 .828-.448 1.5-1 1.5s-1-.672-1-1.5S9.448 5 10 5s1 .672 1 1.5z"/>
        </svg>
      <button id="send_but" type="submit">
        <svg xmlns="http://www.w3.org/2000/svg" width="25" id="send_icon" height="25" fill="currentColor" class="bi bi-send-fill send_icon" viewBox="0 0 16 16">
          <path fill-rule="evenodd" d="M15.964.686a.5.5 0 0 0-.65-.65l-.095.038L.767 5.854l-.001.001-.452.18a.5.5 0 0 0-.082.887l.41.26.001.002 4.563 2.903.432.275.275.432 2.903 4.563.002.002.26.41a.5.5 0 0 0 .886-.083l.181-.453L15.926.78l.038-.095Zm-1.833 1.89.471-1.178-1.178.471L5.93 9.363l.338.215a.5.5 0 0 1 .154.154l.215.338 7.494-7.494Z"/>
        </svg>
      </button>
    </form>
  </section>




</div>
<script src="https://yastatic.net/jquery/3.3.1/jquery.min.js"></script>
<script>






    function send_wall_form(){

        var body = document.forms.wallForm.body.value;
        var token = document.forms.wallForm.authenticity_token.value;
        var tag = document.forms.wallForm.tag.value;


        var xhr = new XMLHttpRequest();
        xhr.open("POST", "/create_wall.json");
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

        body = 'body=' + encodeURIComponent(body) +
            '&authenticity_token=' + encodeURIComponent(token) +
            '&tag=' + encodeURIComponent(tag);

        xhr.onreadystatechange = function (){
            if (xhr.readyState == 4 && xhr.status == 200) {
                document.getElementById('message_input').value = '';


                data = JSON.parse(xhr.responseText)

                document.getElementById("chat-window").innerHTML += `<article class="msg-container msg-self" id="msg-0"><div class="msg-box msg-${data[1]}">` +
                    `<div class="flr"><div class="messages"><p class="msg" id="msg-1">${data[0]}</p></div>`+
                    `<span class="timestamp"><span class="username">Вы</span>&bull;<span class="posttime"> ${data[2]} </span> &bull;` +
                    `${data[3]}</span></div><img class="user-img" id="user-0" src="${data[4]}" /></div></article>`;

                document.getElementById("chat-window").scrollTo(0,30000000000000);



            }
        }
        xhr.send(body)
    }

    function show_walls(){
        document.getElementById("chat-window").scrollTo(1000,10000000000000);
        var xhr = new XMLHttpRequest();
        xhr.open("GET", "/all_walls.json");

        xhr.onreadystatechange = function (){
            if (xhr.readyState == 4 && xhr.status == 200) {
                document.getElementById("records").innerHTML = xhr.responseText;
            }
        }
        xhr.send()
    }


</script>
<style>

    .chat-window {
        flex: auto;
        overflow: scroll;
        height: 830px;
        padding-bottom: 30px;
    }
    .chat-input {
        flex: 0 0 auto;
        height: 60px;
        border-top: 1px solid #575151;
        background: white;
        box-shadow: 0 0 4px rgba(0,0,0,.14),0 4px 8px rgba(0,0,0,.28);
    }
    .chat-input input {
        height: 59px;
        line-height: 60px;
        outline: 0 none;
        border: none;
        width: calc(100% - 150px);
        color: #575151;
        text-indent: 10px;
        font-size: 12pt;
        padding: 0;

    }

    .msg-container {
        position: relative;
        display: inline-block;
        width: 100%;
        margin: 0 0 10px 0;
        padding: 0;
    }
    .msg-box {
        display: flex;
        padding: 10px 10px 0 10px;
        border-radius: 0 6px 6px 0;
        max-width: 80%;
        width: auto;
        float: left;
        box-shadow: 0 0 2px rgba(0,0,0,.12),0 2px 4px rgba(0,0,0,.24);
        margin-top: 25px;
    }
    .msg-random {
        background: #b2b6ea;
    }

    .msg-important {
        background: #c32c3685;
    }

    .msg-interesting {
        background: rgba(175, 38, 255, 0.27);
    }
    .msg-advertisement {
        background: #555a5f78;
    }

    .user-img {
        display: inline-block;
        border-radius: 50%;
        height: 40px;
        width: 40px;
        background: lightgray;
        margin: 0 10px 10px 0;
    }
    .flr {
        flex: 1 0 auto;
        display: flex;
        flex-direction: column;
        width: calc(100% - 50px);
    }
    .messages {
        flex: 1 0 auto;
    }
    .msg {
        display: inline-block;
        font-size: 11pt;
        line-height: 13pt;
        color: rgba(255,255,255,.7);
        margin: 0 0 4px 0;
    }
    .msg:first-of-type {
        margin-top: 8px;
    }
    .timestamp {
        color: rgba(0,0,0,.38);
        font-size: 9pt;
        margin-bottom: 10px;
    }
    .username {
        margin-right: 3px;
    }
    .posttime {
        margin-left: 3px;
    }
    .msg-self .msg-box {
        border-radius: 6px 0 0 6px;
        float: right;
    }
    .msg-self .user-img {
        margin: 0 0 10px 10px;
    }
    .msg-self .msg {
        text-align: right;
    }
    .msg-self .timestamp {
        text-align: right;
    }
#send_but {
    background: inherit;
    border: none;
}

    .send_icon{
        margin-left: 10px;
    }
.send_icon:hover {
 fill: grey;
    cursor: pointer;
    margin-top: 5px !important;
}

    #emoji2 {
        position: absolute;
        top: 567px;
        left: 1360px;
        text-align: left;
        border: 1px solid grey;
        border-bottom: none;
        box-shadow: 0 0 10px rgba(0,0,0,0.5);
        padding-left: 12px;
        background-color: white;
        height: 300px;
        width: 300px;
        max-width: 300px;
        max-height: 300px;
        overflow: auto;
    }

    #tags {
        position: absolute;
        top: 700px;
        left: 1360px;
        text-align: left;
        border: 1px solid grey;
        border-bottom: none;
        box-shadow: 0 0 10px rgba(0,0,0,0.5);
        padding: 15px;
        background-color: white;
        height: 130px;
        width: 200px;
        max-width: 200px;
        max-height: 130px;
        overflow: auto;
        font-size: 16px;
        background-image: url(https://psv4.userapi.com/c536236/u131991696/docs/d5/cc2d70bd92df/back.png?extra=w-9TQjbJa3Jcn8hsbm8iEF04TNdNPqzVKT2ng6ZzS6vUPSByf3Ctq5W7gHSsJ6xWJh-ZcDGk0xzhv8jeeBn9lgmkxMWYzBhjf_HF9iZhK87rP6H7DyzrpmpmJan1K9w05_qT-5Ge94LgY9uGjGeRGoa-_m0); ;
    }
</style>
